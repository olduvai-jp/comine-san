# Comine San

Comine San is a TypeScript tool that loads `workflow_api.json` exported from ComfyUI and runs the workflow from the CLI.

## TL;DR (npx)

First, run `--help` to see the options generated from the workflow you loaded.

```shell
npx --yes @olduvai-jp/comine-san ./path/to/workflow_api.json --help
```

Once you know the options, run it:

```shell
npx --yes @olduvai-jp/comine-san ./path/to/workflow_api.json \
  --output-json ./results/output.json \
  --server http://127.0.0.1:8188 \
  --Prompt_Text.string "test prompt" \
  --SaveImage.filename output/result.png
```

> If `npx` is not available in your environment, you can also run it with `npm exec --yes -- @olduvai-jp/comine-san ...`.

## Features

- Parses input/output nodes in the workflow and auto-generates CLI options in the form `--<node-title>.<input-name>`
- Sends `POST /prompt` to the specified ComfyUI server and monitors progress via WebSocket
- Collects outputs like SaveImage / ShowText / Show Any to JSON into files and a single JSON

## Requirements

- Node.js 18+ (uses the `fetch` API)
- `npx` (npm) / `npm exec` available
- A running ComfyUI server (default: `http://127.0.0.1:8188`)

## Usage

1. Export the target workflow from ComfyUI as `workflow_api.json`.
2. Start the ComfyUI server (e.g. `python main.py --listen 0.0.0.0 --port 8188`).
3. Run `--help` as below to see the available options.

```shell
npx --yes @olduvai-jp/comine-san ./path/to/workflow_api.json --help
```

At the end of the output, available output nodes and field types are shown under `Result types`.

4. Once you have the options you need, build and run the actual command.

```shell
npx --yes @olduvai-jp/comine-san ./path/to/workflow_api.json \
  --output-json ./results/output.json \
  --server http://127.0.0.1:8188 \
  --Prompt_Text.string "test prompt" \
  --SaveImage.filename output/result.png
```

- 1st argument: Path to the workflow JSON
- `--output-json`: Path to the JSON file to save the results (if omitted, `metadata.json` will be created)
  - Use `--output-json -` to print the JSON to stdout (no file will be created)
- `--server`: ComfyUI base URL (if omitted, `http://127.0.0.1:8188`)
- Other options are auto-generated by combining the node title set in ComfyUI (normalized to `[A-Za-z0-9_-]`) and the input key

> Example: If the ComfyUI node title is `Prompt Text` and the input key is `string`, the CLI option becomes `--Prompt_Text.string`.

### Outputs

- Image output nodes (`SaveImage`) save the image file to the specified path.
- Text output nodes (`ShowText|pysssss`, `Show any to JSON [Crystools]`) are stored in the JSON `text` field.
- The JSON file specified by the CLI option `--output-json` aggregates results from each output node as a key-value map.

### Supported Nodes

- **Input** `Primitive string multiline [Crystools]` (string prompts, etc.)
- **Input** `Primitive integer [Crystools]` (integer inputs like seeds)
- **Input** `Primitive float [Crystools]` (float inputs like guidance scale)
- **Input** `ETN_LoadImageBase64` (load images from a file path or an existing Base64 string)
- **Output** `SaveImage` (save images to a file and return the path)
- **Output** `SaveAnimatedWEBP` (save an animated WebP to a file and return the path)
- **Output** `Show any to JSON [Crystools]` (get any value as JSON text)
- **Output** `ShowText|pysssss` (get text output as a multi-line string)

## Documentation

- For detailed CLI usage, see `docs/cli-guide.md`.
- For an overview of the library API, see `docs/library-guide.md`.

## Library Usage Tips

```ts
// CommonJS
const { ComfyUiWorkflow } = require('@olduvai-jp/comine-san');

// ES Modules (tree-shakeable)
import { ComfyUiWorkflow } from '@olduvai-jp/comine-san';

// Subpath examples
import { ComfyAPIClient } from '@olduvai-jp/comine-san/lib';
import { PrimitiveStringCrystools } from '@olduvai-jp/comine-san/nodes/input/primitiveString';
```

- If you want direct access to the CLI execution logic, import `@olduvai-jp/comine-san/cli` (not needed when using `npx`).
- Since optimized `dist/cjs` / `dist/esm` are provided via `exports` for both CJS and ESM, bundlers can remove unused entry points (e.g. `@olduvai-jp/comine-san/cli`).

## Setup (for contributors)

```shell
yarn install
```

To run the CLI locally, you can execute it via `ts-node`.

```shell
yarn start ./path/to/workflow_api.json --help
```

## Development Notes

- Type check: `yarn type-check`
- Build: `yarn build` (generates `dist/cjs` and `dist/esm`)
- CI: runs `yarn type-check` / `yarn build` on Node.js 20 in `.github/workflows/ci.yml`
- Node-specific implementations live under `src/lib/workflow/nodes/`. Add new Input/Output node classes as needed.
